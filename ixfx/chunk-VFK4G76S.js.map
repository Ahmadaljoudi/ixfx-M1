{"version":3,"sources":["../src/dom/index.ts","../src/dom/ShadowDom.ts","../src/dom/Log.ts","../src/dom/DomRx.ts"],"sourcesContent":["\r\nexport * from './Log.js';\r\n\r\nexport * from './DomRx.js';\r\nexport * from './Util.js';\r\n\r\n/**\r\n * Functions for working with DOM elements\r\n */\r\nexport * as Forms from './Forms.js';\r\n\r\n","export const addShadowCss = (parentEl:HTMLElement, styles:string):ShadowRoot => {\r\n  const styleEl = document.createElement(`style`);\r\n  styleEl.textContent = styles;\r\n\r\n  let shadowRoot;\r\n  if (parentEl.shadowRoot) {\r\n    shadowRoot = parentEl.shadowRoot;\r\n    shadowRoot.innerHTML = ``;\r\n  } else {\r\n    shadowRoot = parentEl.attachShadow({ mode: `open` });\r\n  }\r\n  shadowRoot.appendChild(styleEl);\r\n  return shadowRoot;\r\n};\r\n","import {resolveEl} from \"./Util.js\";\r\nimport {addShadowCss} from \"./ShadowDom.js\";\r\n\r\nexport type LogOpts = {\r\n  readonly reverse?:boolean\r\n  readonly capacity?: number\r\n  readonly timestamp?: boolean\r\n  readonly collapseDuplicates?:boolean\r\n  readonly monospaced?:boolean\r\n  readonly minIntervalMs?:number\r\n  readonly css?:string\r\n}\r\n\r\nexport type Log = Readonly<{\r\n  clear():void\r\n  error(msgOrError:string|Error|unknown):void\r\n  log(msg?:string|object|number):HTMLElement|undefined\r\n  append(el:HTMLElement):void\r\n  dispose():void\r\n  readonly isEmpty:boolean\r\n}>\r\n\r\n/**\r\n * Allows writing to a DOM element in console.log style. Element grows in size, so use\r\n * something like `overflow-y: scroll` on its parent\r\n * \r\n * ```\r\n * const l = log(`#dataStream`); // Assumes HTML element with id `dataStream` exists \r\n * l.log(`Hi`);\r\n * l.log(); // Displays a horizontal rule\r\n * \r\n * const l = log(document.getElementById(`dataStream`), {\r\n *  timestamp: true,\r\n *  truncateEntries: 20\r\n * });\r\n * l.log(`Hi`);\r\n * l.error(`Some error`); // Adds class `error` to line\r\n * ```\r\n * \r\n * For logging high-throughput streams:\r\n * ```\r\n * // Silently drop log if it was less than 5ms since the last\r\n * const l = log(`#dataStream`, { minIntervalMs: 5 });\r\n * \r\n * // Only the last 100 entries are kept\r\n * const l = log(`#dataStream`, { capacity: 100 });\r\n * ```\r\n *\r\n * @param {(HTMLElement | string | undefined)} elOrId Element or id of element\r\n * @param {LogOpts} opts\r\n * @returns {Log}\r\n */\r\nexport const log = (domQueryOrEl: HTMLElement | string, opts: LogOpts = {}):Log => {\r\n  // eslint-disable-next-line @typescript-eslint/naming-convention\r\n  const {capacity = 0, monospaced = true, timestamp = false, collapseDuplicates = true, css =  `` } = opts;\r\n\r\n  // eslint-disable-next-line functional/no-let\r\n  let added = 0;\r\n  // eslint-disable-next-line functional/no-let\r\n  let lastLog:string|undefined;\r\n  // eslint-disable-next-line functional/no-let\r\n  let lastLogRepeats = 0;\r\n\r\n  const parentEl = resolveEl<HTMLElement>(domQueryOrEl);\r\n  const fontFamily = monospaced ? `Consolas, \"Andale Mono WT\", \"Andale Mono\", \"Lucida Console\", \"Lucida Sans Typewriter\", \"DejaVu Sans Mono\", \"Bitstream Vera Sans Mono\", \"Liberation Mono\", Monaco, \"Courier New\", Courier, monospace` : `normal`;\r\n  const shadowRoot = addShadowCss(parentEl, `\r\n  .log {\r\n    font-family: ${fontFamily};\r\n    background-color: var(--code-background-color);\r\n    padding: var(--padding1, 0.2em);\r\n    overflow-y: auto;\r\n    height:100%;\r\n  }\r\n  .timestamp {\r\n    margin-right: 0.5em;\r\n    opacity: 0.5;\r\n    font-size: 70%;\r\n    align-self: center;\r\n  }\r\n  .line {\r\n    display: flex;\r\n  }\r\n  .line:hover {\r\n    background-color: var(--theme-bg-hover, whitesmoke);\r\n  }\r\n  .error {\r\n    color: red;\r\n  }\r\n  .badge {\r\n    border: 1px solid currentColor;\r\n    align-self: center;\r\n    font-size: 70%;\r\n    padding-left: 0.2em;\r\n    padding-right: 0.2em;\r\n    border-radius: 1em;\r\n    margin-left: 0.5em;\r\n    margin-right: 0.5em;\r\n  }\r\n  .msg {\r\n    flex: 1;\r\n  }\r\n  ${css}\r\n  `);\r\n  \r\n  const el = document.createElement(`div`);\r\n  // eslint-disable-next-line functional/immutable-data\r\n  el.className = `log`;\r\n  shadowRoot.append(el);\r\n\r\n  const error = (msgOrError: string | Error | unknown) => {\r\n    const line = document.createElement(`div`);\r\n    \r\n    if (typeof msgOrError === `string`) {\r\n      // eslint-disable-next-line functional/immutable-data\r\n      line.innerHTML = msgOrError;\r\n    } else if (msgOrError instanceof Error) {\r\n      const stack = msgOrError.stack;\r\n      if (stack === undefined) {\r\n        // eslint-disable-next-line functional/immutable-data\r\n        line.innerHTML = msgOrError.toString();\r\n      } else {\r\n        // eslint-disable-next-line functional/immutable-data\r\n        line.innerHTML = stack.toString();\r\n      }\r\n    } else {\r\n      // eslint-disable-next-line functional/immutable-data\r\n      line.innerHTML = msgOrError as string;\r\n    }\r\n    line.classList.add(`error`);\r\n    append(line);\r\n    lastLog = undefined;\r\n    lastLogRepeats = 0;\r\n  };\r\n\r\n  //eslint-disable-next-line functional/no-let\r\n  let lastLogTime = 0;\r\n\r\n  const log = (whatToLog: unknown = ``):HTMLElement|undefined => {\r\n    // eslint-disable-next-line functional/no-let\r\n    let msg:string|undefined;\r\n    const interval = window.performance.now() - lastLogTime;\r\n    if (opts.minIntervalMs && interval < opts.minIntervalMs) return;\r\n    lastLogTime = window.performance.now();\r\n\r\n    if (typeof whatToLog === `object`) {\r\n      msg = JSON.stringify(whatToLog);\r\n    } else if (whatToLog === undefined) {\r\n      msg = `(undefined)`;\r\n    } else if (whatToLog === null) {\r\n      msg = `(null)`;\r\n    } else if (typeof whatToLog === `number`) {\r\n      if (Number.isNaN(msg)) msg = `(NaN)`;\r\n      msg = whatToLog.toString();\r\n    } else {\r\n      msg = whatToLog as string;\r\n    }\r\n   \r\n    if (msg.length === 0) {\r\n      const rule = document.createElement(`hr`);\r\n      lastLog = undefined;\r\n      append(rule);\r\n    } else if (msg === lastLog && collapseDuplicates) {\r\n      const lastEl = el.firstElementChild as HTMLElement;\r\n      // eslint-disable-next-line functional/no-let\r\n      let lastBadge = lastEl.querySelector(`.badge`);\r\n      if (lastBadge === null) {\r\n        lastBadge = document.createElement(`div`);\r\n        // eslint-disable-next-line functional/immutable-data\r\n        lastBadge.className = `badge`;\r\n        lastEl.insertAdjacentElement(`beforeend`, lastBadge);\r\n      }\r\n      if (lastEl !== null) {\r\n        // eslint-disable-next-line functional/immutable-data\r\n        lastBadge.textContent = (++lastLogRepeats).toString();\r\n      }\r\n      return lastEl;\r\n    } else {\r\n      const line = document.createElement(`div`);\r\n      // eslint-disable-next-line functional/immutable-data\r\n      line.innerText = msg;\r\n      append(line);\r\n      lastLog = msg;\r\n      return line;\r\n    }\r\n  };\r\n\r\n  const append = (line: HTMLElement) => {\r\n    if (timestamp) {\r\n      const wrapper = document.createElement(`div`);\r\n      const timestamp = document.createElement(`div`);\r\n      // eslint-disable-next-line functional/immutable-data\r\n      timestamp.className = `timestamp`;\r\n      // eslint-disable-next-line functional/immutable-data\r\n      timestamp.innerText = new Date().toLocaleTimeString();\r\n      wrapper.append(timestamp, line);\r\n      line.classList.add(`msg`);\r\n      wrapper.classList.add(`line`);\r\n      line = wrapper;\r\n    } else {\r\n      line.classList.add(`line`, `msg`);\r\n    }\r\n\r\n    if (opts.reverse) {\r\n      el.appendChild(line);\r\n    } else {\r\n      el.insertBefore(line, el.firstChild);\r\n    }\r\n\r\n    if (capacity > 0 && (++added > capacity * 2)) {\r\n      // eslint-disable-next-line functional/no-loop-statement\r\n      while (added > capacity) {\r\n        el.lastChild?.remove();\r\n        added--;\r\n      }\r\n    }\r\n\r\n    if (opts.reverse) {\r\n      // Scroll to bottom\r\n      //eslint-disable-next-line functional/immutable-data\r\n      el.scrollTop = el.scrollHeight;\r\n    }\r\n    lastLogRepeats = 0;\r\n  };\r\n\r\n  const clear = () => {\r\n    // eslint-disable-next-line functional/immutable-data\r\n    el.innerHTML = ``;\r\n    lastLog = undefined;\r\n    lastLogRepeats = 0;\r\n    added = 0;\r\n  };\r\n\r\n  const dispose = () => {\r\n    el.remove();\r\n  };\r\n\r\n  return {\r\n    error, log, append, clear, dispose,\r\n    get isEmpty() {\r\n      return added === 0;\r\n    }\r\n  };\r\n};","import {fromEvent, Observable} from 'rxjs';\r\nimport {map} from 'rxjs/operators';\r\nimport {resolveEl} from './Util.js';\r\n\r\n/**\r\n * @private\r\n */\r\nexport type PluckOpts =  {\r\n  readonly pluck: string\r\n}\r\n\r\n/**\r\n * @private\r\n */\r\nexport type TransformOpts = {\r\n  transform(ev:Event):any\r\n}\r\n\r\n/**\r\n * Responsive value\r\n */\r\n// eslint-disable-next-line functional/no-mixed-type\r\nexport type Rx<V> = {\r\n  /**\r\n   * Last value\r\n   */\r\n  readonly value: V,\r\n  /**\r\n   * Clears last value\r\n   */\r\n  readonly clear: () => void\r\n}\r\n\r\nexport type DomRxOpts = PluckOpts | TransformOpts;\r\n\r\n/**\r\n * Keeps track of last event data\r\n * \r\n * ```js\r\n * const pointer = rx(`#myDiv`, `pointermove`).value;\r\n * \r\n * if (pointer.clientX > ...)\r\n * ``` \r\n * \r\n * Pluck a field:\r\n * ```js\r\n * const pointerX = rx(`#myDiv`, `pointermove`, {pluck: `clientX`}).value;\r\n * \r\n * if (pointerX > ...)\r\n * ```\r\n * @template V Event type\r\n * @param opts\r\n * @return\r\n */\r\nexport const rx = <V>(elOrQuery:HTMLElement|string, event:string, opts?:DomRxOpts):Rx<V> => {\r\n  const el = resolveEl<HTMLElement>(elOrQuery);\r\n  const ev = fromEvent(el, event);\r\n  // @ts-ignore\r\n  const value:V = {};\r\n\r\n  const clear = () => {\r\n    const keys = Object.keys(value);\r\n    keys.forEach(key => {\r\n      // eslint-disable-next-line functional/immutable-data, @typescript-eslint/no-explicit-any\r\n      delete (value as any)[key];\r\n    });\r\n  };\r\n\r\n  const setup = (sub:Observable<Event>):Rx<V> => {\r\n    sub.subscribe({\r\n      next: (newValue) => {\r\n        // eslint-disable-next-line functional/immutable-data, @typescript-eslint/no-explicit-any\r\n        Object.assign(value, newValue);\r\n      }\r\n    });\r\n    return {\r\n      value, clear\r\n    };\r\n  };\r\n\r\n  if (opts === undefined) return setup(ev);\r\n  \r\n  if ((opts as PluckOpts).pluck) {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    return setup(ev.pipe(map(x => (x as any)[(opts as PluckOpts).pluck])));\r\n  } else if ((opts as TransformOpts).transform) {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    return setup(ev.pipe(map(x => (opts as TransformOpts).transform(x))));\r\n  }\r\n\r\n  return setup(ev);\r\n};"],"mappings":"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","names":[]}
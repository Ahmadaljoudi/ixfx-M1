{"version":3,"sources":["../src/temporal/TrackedValue.ts"],"sourcesContent":["import {GetOrGenerate, getOrGenerate} from \"../collections/Map.js\";\r\n\r\nexport type Timestamped<V> = V & {\r\n  readonly at:number\r\n};\r\n\r\nexport type Opts = {\r\n  readonly storeIntermediate?:boolean\r\n  readonly resetAfterSamples?:number\r\n}\r\n/**\r\n * A tracked value of type `V`.\r\n */\r\nexport class TrackedValue<V> {\r\n  values:Timestamped<V>[];\r\n  seenCount:number;\r\n\r\n  protected storeIntermediate:boolean;\r\n  protected resetAfterSamples:number;\r\n\r\n  constructor(readonly id:string, initial:V, opts:Opts = {}) {\r\n    this.storeIntermediate = opts.storeIntermediate ?? false;\r\n    this.resetAfterSamples = opts.resetAfterSamples ?? -1;\r\n\r\n    this.seenCount = 0;\r\n    const s = {...initial, at:Date.now()} as Timestamped<V>;\r\n    this.values = [s];\r\n  }\r\n\r\n  reset() {\r\n    this.values = this.values.slice(1);\r\n    this.seenCount = 0;\r\n    this.onReset();\r\n  }\r\n\r\n  /**\r\n   * Allows sub-classes to be notified when a reset happens\r\n   */\r\n  //eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  protected onReset() {\r\n\r\n  }\r\n\r\n  /**\r\n   * Tracks a value\r\n   */\r\n  //eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  seen(...p:V[]|Timestamped<V>[]):any {\r\n    // Make sure values have a timestamp\r\n    const ts = p.map(v => ((`at` in v) ? v : {\r\n      ...v,\r\n      at: Date.now()\r\n    }));\r\n\r\n    if (this.resetAfterSamples > 0 && this.seenCount > this.resetAfterSamples) {\r\n      this.reset();\r\n    }\r\n\r\n    this.seenCount += p.length;\r\n    const last = ts.at(-1) as Timestamped<V>;\r\n  \r\n    if (this.storeIntermediate) this.values.push(...ts);\r\n    else if (this.values.length === 2) {\r\n      this.values[1] = last;\r\n    } else {\r\n      this.values.push(last);\r\n    }\r\n\r\n    this.onSeen(ts);\r\n    return this;\r\n  }\r\n\r\n  //eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  protected onSeen(_values:Timestamped<V>[]) {\r\n\r\n  }\r\n  /**\r\n   * Last seen value. If no values have been added, it will return the initial value\r\n   */\r\n  get last() {\r\n    if (this.values.length === 1) return this.values[0];\r\n    //eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n    return this.values.at(-1)!;\r\n  }\r\n  \r\n  /**\r\n   * Returns number of recorded values (this can include the initial value)\r\n   */\r\n  get size() {\r\n    return this.values.length;\r\n  }\r\n\r\n  /**\r\n   * Returns the elapsed time, in milliseconds since the instance was created\r\n   */\r\n  get elapsed():number {\r\n    return Date.now() - this.values[0].at;\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * PointTracker. Mutable.\r\n */\r\nexport class TrackedValueMap<V>  {\r\n  store:Map<string, TrackedValue<V>>;\r\n  gog:GetOrGenerate<string, TrackedValue<V>, V>;\r\n\r\n  constructor(creator:(key:string, start:V|undefined) => TrackedValue<V>) {\r\n    this.store = new Map();\r\n    this.gog = getOrGenerate<string, TrackedValue<V>, V>(this.store, creator);\r\n  }\r\n\r\n  /**\r\n   * Return number of named points being tracked\r\n   */\r\n  get size() {\r\n    return this.store.size;\r\n  }\r\n\r\n  /**\r\n   * Returns true if `id` is stored\r\n   * @param id \r\n   * @returns \r\n   */\r\n  has(id:string) {\r\n    return this.store.has(id);\r\n  }\r\n\r\n  /**\r\n   * For a given id, note that we have seen one or more values.\r\n   * @param id Id\r\n   * @param values Values(s)\r\n   * @returns Information about start to last value\r\n   */\r\n  //eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  public async seen(id:string, ...values:V[]):Promise<any> {\r\n    const trackedValue = await this.getTrackedValue(id, ...values);\r\n    \r\n    // Pass it over to the TrackedValue\r\n    return trackedValue.seen(...values);\r\n  }\r\n\r\n  /**\r\n   * Creates or returns a TrackedValue instance for `id`.\r\n   * @param id \r\n   * @param values \r\n   * @returns \r\n   */\r\n  protected async getTrackedValue(id:string, ...values:V[]) {\r\n    if (id === null) throw new Error(`id parameter cannot be null`);\r\n    if (id === undefined) throw new Error(`id parameter cannot be undefined`);\r\n\r\n    // Create or recall TrackedValue by id\r\n    const trackedValue = await this.gog(id, values[0]);\r\n    return trackedValue;\r\n  }\r\n\r\n  /**\r\n   * Remove a tracked value by id.\r\n   * Use {@link reset} to clear them all.\r\n   * @param id\r\n   */\r\n  delete(id:string) {\r\n    this.store.delete(id);\r\n  }\r\n\r\n  /**\r\n   * Remove all tracked values.\r\n   * Use {@link delete} to remove a single value by id.\r\n   */\r\n  reset() {\r\n    this.store = new Map();\r\n  }\r\n\r\n  /**\r\n   * Enumerate ids\r\n   */\r\n  *ids() {\r\n    yield* this.store.keys();\r\n  }\r\n\r\n  /**\r\n   * Enumerate tracked values\r\n   */\r\n  *values() {\r\n    yield* this.store.values();\r\n  }\r\n\r\n  /**\r\n   * Returns TrackedValues ordered with oldest first\r\n   * @returns \r\n   */\r\n  getByAge():readonly TrackedValue<V>[] {\r\n    const tp = Array.from(this.store.values());\r\n    tp.sort((a, b) => {\r\n      const aa =a.elapsed;\r\n      const bb = b.elapsed;\r\n      if (aa === bb) return 0;\r\n      if (aa > bb) return -1;\r\n      return 1;\r\n    });\r\n    return tp;\r\n  }\r\n\r\n  /**\r\n   * Enumerate last received values\r\n   * \r\n   * @example Calculate centroid of latest-received values\r\n   * ```js\r\n   * const pointers = pointTracker();\r\n   * const c = Points.centroid(...Array.from(pointers.lastPoints()));\r\n   * ```\r\n   */\r\n  *last() {\r\n    //eslint-disable-next-line functional/no-loop-statement\r\n    for (const p of this.store.values()) {\r\n      yield p.last;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enumerate starting values\r\n   */\r\n  *startValues() {\r\n    //eslint-disable-next-line functional/no-loop-statement\r\n    for (const p of this.store.values()) {\r\n      yield p.values[0];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a tracked value by id, or undefined if not found\r\n   * @param id \r\n   * @returns \r\n   */\r\n  get(id:string):TrackedValue<V>|undefined {\r\n    return this.store.get(id);\r\n  }\r\n}\r\n\r\n\r\n"],"mappings":"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","names":[]}
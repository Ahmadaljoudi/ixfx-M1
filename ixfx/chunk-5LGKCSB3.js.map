{"version":3,"sources":["../src/Events.ts","../src/collections/SimpleMapArray.ts"],"sourcesContent":["/* eslint-disable */\r\nimport { simpleMapArrayMutable } from \"./collections/SimpleMapArray.js\";\r\nexport type Listener<Events> = (ev: unknown, sender: SimpleEventEmitter<Events>) => void;\r\n\r\n// type FlowSource = {\r\n//   name:string,\r\n//   dispose():void,\r\n//   input:FlowSink,\r\n// };\r\n\r\n// type FlowHandler = (args?:any) => void;\r\n\r\n// interface FlowSink {\r\n//  [key:string]: FlowHandler;\r\n// }\r\n\r\n// export type Debouncer = {\r\n//   reset:()=>void\r\n//   dispose:()=>void\r\n// }\r\n\r\n// const sinkify = (handler:FlowHandler): FlowSink => ({ '*': handler });\r\n\r\n// export const debounceFactory = (sink:FlowSink, opts:{timeoutMs:number}): FlowSource => {\r\n//   let timer:number|undefined;\r\n\r\n//   const input = sinkify(() => {\r\n//     //console.log(`debounce reset`);\r\n//     if (timer) window.clearTimeout(timer);\r\n//     timer = window.setTimeout(() => { sink[`*`](null); }, opts.timeoutMs);\r\n//   });\r\n\r\n//   const dispose = () => {\r\n//     if (timer) window.clearTimeout(timer);\r\n//     timer = undefined;\r\n//   };\r\n\r\n//   return { input, dispose, name:`debounce` };\r\n// };\r\n\r\n// export const debounce = (triggered:()=>void, timeoutMs:number):Debouncer => {\r\n//   const opts = { timeoutMs: timeoutMs};\r\n  \r\n//   const sink:FlowSink = {\r\n//     '*': () => {\r\n//       triggered();\r\n//     }\r\n//   };\r\n//   const source = debounceFactory(sink, opts);\r\n//   const reset = () => {\r\n//     source.input[`*`](null);\r\n//   };\r\n//   return {...source, reset};\r\n// };\r\n\r\nexport interface ISimpleEventEmitter<Events> {\r\n  addEventListener<K extends keyof Events>(type: K, listener: (ev: Events[K], sender: SimpleEventEmitter<Events>) => void): void;\r\n  removeEventListener<K extends keyof Events>(type: K, listener: (ev: Events[K], sender: SimpleEventEmitter<Events>) => void):void;\r\n};\r\n\r\nexport class SimpleEventEmitter<Events> implements ISimpleEventEmitter<Events> {\r\n  readonly #listeners = simpleMapArrayMutable<Listener<Events>>();\r\n\r\n  /**\r\n   * Fire event\r\n   * @private\r\n   * @param type Type of event \r\n   * @param args Arguments for event\r\n   * @returns\r\n   */\r\n  protected fireEvent<K extends keyof Events>(type: K, args: Events[K]) {\r\n    const listeners = this.#listeners.get(type as string);\r\n    if (listeners === undefined) return;\r\n    listeners.forEach(l => {\r\n      try {\r\n        l(args, this);\r\n      } catch (err) {\r\n        console.debug(`Event listener error: `, err);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Adds event listener\r\n   *\r\n   * @template K\r\n   * @param {K} type\r\n   * @param {Listener<Events>} listener\r\n   * @memberof SimpleEventEmitter\r\n   */\r\n  addEventListener<K extends keyof Events>(type: K, listener: (ev: Events[K], sender: SimpleEventEmitter<Events>) => void): void { // (this: any, ev: Events[K]) => any): void {\r\n    this.#listeners.add(type as string, listener as Listener<Events>);\r\n  }\r\n  \r\n  /**\r\n   * Remove event listener\r\n   *\r\n   * @param {Listener<Events>} listener\r\n   * @memberof SimpleEventEmitter\r\n   */\r\n  removeEventListener<K extends keyof Events>(type: K, listener: (ev: Events[K], sender: SimpleEventEmitter<Events>) => void) { // listener: Listener<Events>): void {\r\n    this.#listeners.delete(type as string, listener as Listener<Events>);\r\n  }\r\n\r\n  /**\r\n   * Clear all event listeners\r\n   * @private\r\n   * @memberof SimpleEventEmitter\r\n   */\r\n  clearEventListeners() {\r\n    this.#listeners.clear();\r\n  }\r\n}\r\n\r\n// type TestEventMap = {\r\n//   readonly change: TestEvent\r\n//   readonly other: TestEvent2;\r\n// }\r\n\r\n// interface TestEvent2 {\r\n//   readonly something: string;\r\n// }\r\n// interface TestEvent {\r\n//   readonly blah: boolean;\r\n// }\r\n\r\n// class TestEmitter extends SimpleEventEmitter<TestEventMap> {\r\n//   constructor() {\r\n//     super();\r\n//     this.addEventListener(`change`, (e) => {\r\n//       e.blah;\r\n//     });\r\n//   }\r\n// }\r\n\r\n/*\r\nexport class Event {\r\n  public target: any;\r\n  public type: string;\r\n  constructor(type: string, target: any) {\r\n    this.target = target;\r\n    this.type = type;\r\n  }\r\n}\r\n\r\nexport class ErrorEvent extends Event {\r\n  public message: string;\r\n  public error: Error;\r\n  constructor(error: Error, target: any) {\r\n    super('error', target);\r\n    this.message = error.message;\r\n    this.error = error;\r\n  }\r\n}\r\n\r\nexport class CloseEvent extends Event {\r\n  public code: number;\r\n  public reason: string;\r\n  public wasClean = true;\r\n  constructor(code = 1000, reason = '', target: any) {\r\n    super('close', target);\r\n    this.code = code;\r\n    this.reason = reason;\r\n  }\r\n}\r\nexport interface WebSocketEventMap {\r\n  close: CloseEvent;\r\n  error: ErrorEvent;\r\n  message: MessageEvent;\r\n  open: Event;\r\n}\r\n\r\nexport interface WebSocketEventListenerMap {\r\n  close: (event: CloseEvent) => void | {handleEvent: (event: CloseEvent) => void};\r\n  error: (event: ErrorEvent) => void | {handleEvent: (event: ErrorEvent) => void};\r\n  message: (event: MessageEvent) => void | {handleEvent: (event: MessageEvent) => void};\r\n  open: (event: Event) => void | {handleEvent: (event: Event) => void};\r\n}\r\n*/","import {SimpleMapArrayMutable} from \"./Interfaces.js\";\r\n\r\nclass SimpleMapArrayMutableImpl<V> {\r\n  /* eslint-disable-next-line functional/prefer-readonly-type */\r\n  readonly #map: Map<string, ReadonlyArray<V>> = new Map();\r\n\r\n  add(key: string, ...values: ReadonlyArray<V>) {\r\n    const existing = this.#map.get(key);\r\n    if (existing === undefined) {\r\n      this.#map.set(key, values);\r\n    } else {\r\n      this.#map.set(key, [...existing, ...values]);\r\n    }\r\n  }\r\n\r\n  keys():IterableIterator<string> {\r\n    return this.#map.keys();\r\n  }\r\n\r\n  \r\n  debugString(): string {\r\n    // eslint-disable-next-line functional/no-let\r\n    let r = ``;\r\n    const keys = Array.from(this.#map.keys());\r\n    keys.every(k => {\r\n      const v = this.#map.get(k);\r\n      if (v === undefined) return;\r\n      r += k + ` (${v.length}) = ${JSON.stringify(v)}\\r\\n`;\r\n    });\r\n    return r;\r\n  }\r\n\r\n  get(key: string): ReadonlyArray<V> | undefined {\r\n    return this.#map.get(key);\r\n  }\r\n\r\n  delete(key: string, v: V): boolean {\r\n    const existing = this.#map.get(key);\r\n    if (existing === undefined) return false;\r\n    const without = existing.filter(i => i !== v);\r\n    this.#map.set(key, without);\r\n    return without.length < existing.length;\r\n  }\r\n\r\n  clear() {\r\n    this.#map.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * A simple mutable map of arrays, without events. It can store multiple values\r\n * under the same key.\r\n * \r\n * For a fancier approaches, consider {@link mapArray}, {@link mapCircularMutable} or {@link mapSet}.\r\n * \r\n * @example\r\n * ```js\r\n * const m = simpleMapArrayMutable();\r\n * m.add(`hello`, 1, 2, 3); // Adds numbers under key `hello`\r\n * m.delete(`hello`);       // Deletes everything under `hello`\r\n * \r\n * const hellos = m.get(`hello`); // Get list of items under `hello`\r\n * ```\r\n *\r\n * @template V Type of items\r\n * @returns New instance\r\n */\r\nexport const simpleMapArrayMutable = <V>():SimpleMapArrayMutable<V> => new SimpleMapArrayMutableImpl();"],"mappings":";;;;;;;AAAA;AAAA;AAAA;AAAA;;;ACAA;AAEA,IAAM,4BAAN,MAAmC;AAAA,EAAnC;AAEE,uBAAS,MAAsC,oBAAI,IAAI;AAAA;AAAA,EAEvD,IAAI,QAAgB,QAA0B;AAC5C,UAAM,WAAW,mBAAK,MAAK,IAAI,GAAG;AAClC,QAAI,aAAa,QAAW;AAC1B,yBAAK,MAAK,IAAI,KAAK,MAAM;AAAA,IAC3B,OAAO;AACL,yBAAK,MAAK,IAAI,KAAK,CAAC,GAAG,UAAU,GAAG,MAAM,CAAC;AAAA,IAC7C;AAAA,EACF;AAAA,EAEA,OAAgC;AAC9B,WAAO,mBAAK,MAAK,KAAK;AAAA,EACxB;AAAA,EAGA,cAAsB;AAEpB,QAAI,IAAI;AACR,UAAM,OAAO,MAAM,KAAK,mBAAK,MAAK,KAAK,CAAC;AACxC,SAAK,MAAM,OAAK;AACd,YAAM,IAAI,mBAAK,MAAK,IAAI,CAAC;AACzB,UAAI,MAAM;AAAW;AACrB,WAAK,IAAI,KAAK,EAAE,aAAa,KAAK,UAAU,CAAC;AAAA;AAAA,IAC/C,CAAC;AACD,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,KAA2C;AAC7C,WAAO,mBAAK,MAAK,IAAI,GAAG;AAAA,EAC1B;AAAA,EAEA,OAAO,KAAa,GAAe;AACjC,UAAM,WAAW,mBAAK,MAAK,IAAI,GAAG;AAClC,QAAI,aAAa;AAAW,aAAO;AACnC,UAAM,UAAU,SAAS,OAAO,OAAK,MAAM,CAAC;AAC5C,uBAAK,MAAK,IAAI,KAAK,OAAO;AAC1B,WAAO,QAAQ,SAAS,SAAS;AAAA,EACnC;AAAA,EAEA,QAAQ;AACN,uBAAK,MAAK,MAAM;AAAA,EAClB;AACF;AA3CW;AA+DJ,IAAM,wBAAwB,MAAkC,IAAI,0BAA0B;;;ADnErG;AA4DO,IAAM,qBAAN,MAAwE;AAAA,EAAxE;AACL,uBAAS,YAAa,sBAAwC;AAAA;AAAA,EAS9D,AAAU,UAAkC,MAAS,MAAiB;AACpE,UAAM,YAAY,mBAAK,YAAW,IAAI,IAAc;AACpD,QAAI,cAAc;AAAW;AAC7B,cAAU,QAAQ,OAAK;AACrB,UAAI;AACF,UAAE,MAAM,IAAI;AAAA,MACd,SAAS,KAAP;AACA,gBAAQ,MAAM,0BAA0B,GAAG;AAAA,MAC7C;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAUA,iBAAyC,MAAS,UAA6E;AAC7H,uBAAK,YAAW,IAAI,MAAgB,QAA4B;AAAA,EAClE;AAAA,EAQA,oBAA4C,MAAS,UAAuE;AAC1H,uBAAK,YAAW,OAAO,MAAgB,QAA4B;AAAA,EACrE;AAAA,EAOA,sBAAsB;AACpB,uBAAK,YAAW,MAAM;AAAA,EACxB;AACF;AAnDW;","names":[]}